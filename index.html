<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Scanner de Ropa IA</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #222; color: white; }
        video { border: 5px solid #444; border-radius: 10px; width: 100%; max-width: 400px; transform: scaleX(-1); }
        #resultado { font-size: 2rem; font-weight: bold; color: #00ff00; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Scanner de Ropa IA</h1>
    <video id="video" playsinline autoplay></video>
    <canvas id="canvas" width="28" height="28" style="display:none;"></canvas>
    <div id="resultado">Cargando cerebro de IA...</div>

    <script>
        let modelo = null;
        const video = document.getElementById("video");
        const canvas = document.getElementById("canvas");
        const clases = ['Camiseta', 'Pantalón', 'Suéter', 'Vestido', 'Abrigo', 'Sandalia', 'Camisa', 'Zapatilla', 'Bolso', 'Botín'];

        async function cargarModelo() {
            try {
                // Forzamos la carga ignorando el error de capas de entrada
                modelo = await tf.loadLayersModel('model.json', {strict: false});
                
                // Si el modelo cargó, le inyectamos la forma de entrada manualmente
                if (modelo) {
                    modelo.layers[0].batchInputShape = [null, 28, 28, 1];
                    console.log("Modelo cargado con parche de compatibilidad");
                }

                document.getElementById("resultado").innerText = "¡IA Lista! Enfoca tu ropa";
                predecir();
            } catch (err) {
                document.getElementById("resultado").innerText = "Error: " + err.message;
            }
        }

        async function predecir() {
            if (modelo != null) {
                const ctx = canvas.getContext("2d", {willReadFrequently: true});
                ctx.drawImage(video, 0, 0, 28, 28);
                const imgData = ctx.getImageData(0, 0, 28, 28);

                let tensor = tf.browser.fromPixels(imgData, 1)
                    .reshape([1, 28, 28, 1])
                    .cast('float32')
                    .div(tf.scalar(255));

                const prediccion = modelo.predict(tensor).dataSync();
                const indiceMax = prediccion.indexOf(Math.max(...prediccion));
                document.getElementById("resultado").innerText = clases[indiceMax];
            }
            requestAnimationFrame(predecir);
        }

        navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}})
            .then(stream => { video.srcObject = stream; cargarModelo(); })
            .catch(err => { document.getElementById("resultado").innerText = "Error: Activa la cámara"; });
    </script>
</body>
</html>
